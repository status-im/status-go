pipeline {
  agent { label 'linux' }

  parameters {
    booleanParam(
      name: 'RELEASE',
      description: 'Enable to create a new release on GitHub and DigitalOcean Space.',
      defaultValue: false,
    )
  }

  options {
    disableConcurrentBuilds()
    /* Go requires a certain directory structure */
    checkoutToSubdirectory('src/github.com/status-im/status-go')
    /* manage how many builds we keep */
    buildDiscarder(logRotator(
      numToKeepStr: '30',
      daysToKeepStr: '30',
    ))
  }

  environment {
    STATUS_PATH = 'src/github.com/status-im/status-go'
    GOPATH = "${env.WORKSPACE}"
    PATH = "${env.PATH}:${env.GOPATH}/bin"
  }

  stages {
    stage('Prep') {
      steps { script {
        lib = load("${env.STATUS_PATH}/_assets/ci/lib.groovy")
        version = readFile("${STATUS_PATH}/VERSION").trim()
        println("Version: ${version}")
        println("Git Branch: ${lib.gitBranch()}")
        println("Git Commit: ${lib.gitCommit()}")
      } }
    } // stage(Prep)

    stage('Build') {
      parallel {
        stage('Android') {
          agent { label 'linux' }

          environment {
            STATUS_PATH = 'src/github.com/status-im/status-go'
            GOPATH = "${env.WORKSPACE}"
            PATH = "${env.PATH}:${env.GOPATH}/bin"
            ANDROID_HOME = '/usr/lib/android-sdk'
            ANDROID_SDK_ROOT = '/usr/lib/android-sdk'
            ANDROID_NDK = '/usr/lib/android-ndk'
            ANDROID_NDK_HOME = '/usr/lib/android-ndk'
          }

          stages {
            stage('Prep') {
              steps { script {
                /* save and create a dir for artifacts */
                destAndroid = "${env.WORKSPACE}/pkg-android"
                sh "mkdir -p ${destAndroid}"
              } }
            }

            stage('Setup') { steps { dir(env.STATUS_PATH) {
              sh 'make setup-build'
            } } }

            //stage('Lint') { steps { dir(env.STATUS_PATH) {
            //  sh 'make ci'
            //} } }

            stage('Compile') { steps { dir(env.STATUS_PATH) {
              sh 'make statusgo-android'
              sh "cp build/bin/statusgo.aar ${destAndroid}/status-go-android-${lib.suffix()}.aar"
            } } }

            stage('Archive') { steps {
              stash(name: 'android', includes: "${env.STATUS_PATH}/build/bin/statusgo.aar")
              archiveArtifacts("pkg-android/status-go-android-${lib.suffix()}.aar")
              stash(name: 'android', includes: "${env.STATUS_PATH}/build/bin/statusgo.aar")
            } }

            stage('Upload') { steps { script {
              lib.uploadArtifact("pkg-android/status-go-android-${lib.suffix()}.aar")
            } } }

            stage('Cleanup') { steps { script {
              sh "rm -fr ${destAndroid}"
            } } }
          }
        } // stage(Android)

        stage('iOS') {
          agent { label 'macos' }

          environment {
            STATUS_PATH = 'src/github.com/status-im/status-go'
            GOPATH = "${env.WORKSPACE}"
            PATH = "${env.PATH}:${env.GOPATH}/bin"
          }

          stages {
            stage('Prep') {
              steps { script {
                /* save and create a dir for artifacts */
                destIOS = "${env.WORKSPACE}/pkg-ios"
                sh "mkdir -p ${destIOS}"
              } }
            }

            stage('Setup') { steps { dir(env.STATUS_PATH) {
              sh 'make setup-build'
            } } }

            //stage('Lint') { steps { dir(env.STATUS_PATH) {
            //  sh 'make ci'
            //} } }

            stage('Compile') { steps { dir(env.STATUS_PATH) {
              sh 'make statusgo-ios'
              dir('build/bin') {
                sh 'zip -r status-go-ios.zip Statusgo.framework'
                sh "cp status-go-ios.zip ${destIOS}/status-go-ios-${lib.suffix()}.zip"
              }
            } } }

            stage('Archive') { steps {
              dir("${env.STATUS_PATH}/build/bin") {
                stash(name: 'ios', includes: 'status-go-ios.zip')
              }
              archiveArtifacts("pkg-ios/status-go-ios-${lib.suffix()}.zip")
            } }

            stage('Upload') { steps { script {
              lib.uploadArtifact("pkg-ios/status-go-ios-${lib.suffix()}.zip")
            } } }

            stage('Cleanup') { steps { script {
              sh "rm -fr ${destIOS}"
            } } }
          }
        } // stage(iOS)

        stage('Desktop') {
          agent { label 'linux' }

          environment {
            STATUS_PATH = 'src/github.com/status-im/status-go'
          }

          stages {
            stage('Prep') {
              steps { script {
                /* save and create a dir for artifacts */
                dest = "${env.WORKSPACE}/pkg-desktop"
                sh "mkdir -p ${dest}"
              } }
            }

            stage('Zip') { steps { dir(env.STATUS_PATH) {
              sh "zip -r ${dest}/status-go-desktop-${lib.suffix()}.zip . -x *.git"
            }}}

            stage('Archive') { steps {
              archiveArtifacts("pkg-desktop/status-go-desktop-${lib.suffix()}.zip")
            } }

            stage('Upload') { steps { script {
              lib.uploadArtifact("pkg-desktop/status-go-desktop-${lib.suffix()}.zip")
            } } }

            stage('Cleanup') { steps { script {
              sh "rm -fr ${dest}"
            } } }
          }
        } // stage(Desktop)
      } // parallel
    } // stage(Build)

    stage('Release') { when { expression { params.RELEASE == true } }
      steps {
        dir(env.STATUS_PATH) {
          sh "mkdir -p ${env.STATUS_PATH}/build/bin"

          dir("${env.STATUS_PATH}/build/bin") {
            unstash 'ios' // zip file
            sh 'unzip status-go-ios.zip'
            sh 'pwd'
            sh 'ls'
            unstash 'android'
          }

          sh 'pwd'
          sh 'ls'
          sh 'ls build/bin'

          sh 'make prepare-release'
          withCredentials([[
            $class: 'UsernamePasswordMultiBinding',
            credentialsId: 'status-im-auto',
            usernameVariable: 'GITHUB_USER',
            passwordVariable: 'GITHUB_TOKEN'
          ]]) {
            sh "yes | make release RELEASE_BRANCH=${lib.gitBranch()}"
          }
          sh 'make clean-release'
        }
      }
    } // stage(Release)
  } // stages
}
